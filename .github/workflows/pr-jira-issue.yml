name: PR Jira Issue
on:
  pull_request:
    types: [closed]
permissions:
  contents: write
  pull-requests: write
  issues: write
jobs:
  handle-pr-closure:
    runs-on: ubuntu-latest
    steps:
      - name: Extract Jira ticket number
        id: extract
        run: |
          BRANCH_NAME="${{ github.head_ref }}"
          PR_TITLE="${{ github.event.pull_request.title }}"
          
          # 브랜치명에서 추출
          if [[ $BRANCH_NAME =~ (FLINT-[0-9]+) ]]; then
            echo "ticket=${BASH_REMATCH[1]}" >> $GITHUB_OUTPUT
            echo "Found ticket in branch: ${BASH_REMATCH[1]}"
          # PR 제목에서 추출
          elif [[ $PR_TITLE =~ \[(FLINT-[0-9]+)\] ]]; then
            echo "ticket=${BASH_REMATCH[1]}" >> $GITHUB_OUTPUT
            echo "Found ticket in title: ${BASH_REMATCH[1]}"
          else
            echo "No Jira ticket found"
            exit 0
          fi

      - name: Find GitHub issue by Jira ticket
        id: find-issue
        if: steps.extract.outputs.ticket
        uses: actions/github-script@v7
        with:
          script: |
            const ticket = '${{ steps.extract.outputs.ticket }}';
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open'
            });
            
            const issue = issues.data.find(i => i.title.includes(`[${ticket}]`));
            if (issue) {
              console.log(`Found issue #${issue.number}`);
              core.setOutput('issue_number', issue.number.toString());
            } else {
              console.log('No matching issue found');
            }

      - name: Login to Jira
        if: steps.extract.outputs.ticket
        uses: atlassian/gajira-login@v3
        env:
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}

      # ========== PR 머지된 경우 ==========
      - name: Transition to Done
        if: steps.extract.outputs.ticket && github.event.pull_request.merged == true
        uses: atlassian/gajira-transition@v3
        with:
          issue: ${{ steps.extract.outputs.ticket }}
          transition: "완료"

      - name: Delete merged branch
        if: github.event.pull_request.merged == true
        uses: actions/github-script@v7
        with:
          script: |
            try {
              await github.rest.git.deleteRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: `heads/${{ github.head_ref }}`
              });
              console.log('Branch deleted successfully');
            } catch (error) {
              console.log('Branch already deleted or error:', error.message);
            }

      - name: Close GitHub issue
        if: steps.find-issue.outputs.issue_number && github.event.pull_request.merged == true
        uses: actions-cool/issues-helper@v3
        with:
          actions: 'close-issue'
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ steps.find-issue.outputs.issue_number }}

      - name: Add completion comment
        if: steps.find-issue.outputs.issue_number && github.event.pull_request.merged == true
        uses: actions-cool/issues-helper@v3
        with:
          actions: 'create-comment'
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ steps.find-issue.outputs.issue_number }}
          body: |
            ✅ 작업 완료
            
            - PR: #${{ github.event.pull_request.number }}
            - Jira: [${{ steps.extract.outputs.ticket }}](${{ secrets.JIRA_BASE_URL }}/browse/${{ steps.extract.outputs.ticket }})
            - 상태: 완료

      # ========== PR 취소된 경우 ==========
      - name: Transition to In Progress
        if: steps.extract.outputs.ticket && github.event.pull_request.merged == false
        uses: atlassian/gajira-transition@v3
        with:
          issue: ${{ steps.extract.outputs.ticket }}
          transition: "진행 중"

      - name: Add cancellation comment
        if: steps.find-issue.outputs.issue_number && github.event.pull_request.merged == false
        uses: actions-cool/issues-helper@v3
        with:
          actions: 'create-comment'
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ steps.find-issue.outputs.issue_number }}
          body: |
            ⚠️ PR이 취소되었습니다
            
            - PR: #${{ github.event.pull_request.number }}
            - Jira 상태: 진행 중으로 변경됨
            - 브랜치와 이슈는 유지됩니다