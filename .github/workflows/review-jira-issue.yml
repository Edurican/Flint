name: Move Jira to In Review
on:
  pull_request:
    types: [opened, reopened]
permissions:
  contents: read
  pull-requests: write
jobs:
  update-jira-status:
    runs-on: ubuntu-latest
    steps:
      - name: Extract Jira ticket number
        id: extract
        run: |
          BRANCH_NAME="${{ github.head_ref }}"
          PR_TITLE="${{ github.event.pull_request.title }}"
          
          if [[ $BRANCH_NAME =~ ^(FLINT-[0-9]+) ]]; then
            echo "ticket=${BASH_REMATCH[1]}" >> $GITHUB_OUTPUT
            echo "Found ticket in branch: ${BASH_REMATCH[1]}"
          elif [[ $PR_TITLE =~ \[(FLINT-[0-9]+)\] ]]; then
            echo "ticket=${BASH_REMATCH[1]}" >> $GITHUB_OUTPUT
            echo "Found ticket in title: ${BASH_REMATCH[1]}"
          else
            echo "No Jira ticket found"
            exit 0
          fi

      - name: Assign random reviewers
        run: |
          ALL_MEMBERS=("Apeirogon99" "ChoiKYH" "haengguk" "ucb1122")

          AUTHOR="${{ github.event.pull_request.user.login }}"

          AVAILABLE_MEMBERS=()
          for member in "${ALL_MEMBERS[@]}"; do
            if [ "$member" != "$AUTHOR" ]; then
              AVAILABLE_MEMBERS+=("$member")
            fi
          done
          
          SHUFFLED=($(printf '%s\n' "${AVAILABLE_MEMBERS[@]}" | shuf))
          
          REVIEWER1="${SHUFFLED[0]}"
          REVIEWER2="${SHUFFLED[1]}"
          
          echo "Selected reviewers: $REVIEWER1, $REVIEWER2"
          
          gh pr edit ${{ github.event.pull_request.number }} \
            --add-reviewer "$REVIEWER1,$REVIEWER2"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Login to Jira
        if: steps.extract.outputs.ticket
        uses: atlassian/gajira-login@v3
        env:
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}

      - name: Transition to In Review
        if: steps.extract.outputs.ticket
        uses: atlassian/gajira-transition@v3
        with:
          issue: ${{ steps.extract.outputs.ticket }}
          transition: "검토 중"
